<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="utf-8">
	<title>Inserir Título</title>
	<!-- Bootstrap CSS -->
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"
		integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
</head>

<body>
	<!-- Menu do Topo da Página -->
	<nav class="sidebar">
		<ul class="nav flex-row">
			<li class="nav-item">
				<a class="nav-link" href="#" data-bs-toggle="modal" data-bs-target="#modalInserirTarefa"> Cadastrar </a>
			</li>
			<li class="nav-item">
				<a class="nav-link" href="#" data-bs-toggle="modal" data-bs-target="#modalBuscarTarefa"> Buscar </a>
			</li>
		</ul>
	</nav>

	<table class="table" id="tabelaprincipal">
		<thead>
			<tr>
				<th scope="col">Id</th>
				<th scope="col">Título</th>
				<th scope="col">Descrição</th>
				<th scope="col">Data de Inserção</th>
				<th scope="col">Prioridade</th>
				<th scope="col">Ação</th>
			</tr>
		</thead>
		<tbody>
		</tbody>
	</table>

	<!-- Modal Inserir Tarefa -->
	<div class="modal fade" id="modalInserirTarefa" tabindex="-1" aria-labelledby="exampleModalLabel"
		aria-hidden="true">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" id="exampleModalLabel">Cadastrar Nova Tarefa</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
				</div>
				<div class="modal-body">
					<Form>

						<div class="mb-3">
							<label for="titulo" class="form-label">Título</label>
							<input type="text" class="form-control" id="titulo" placeholder="insira aqui o título">
						</div>
						<div class="mb-3">
							<label for="descricao" class="form-label">Descrição</label>
							<input type="text" class="form-control" id="descricao"
								placeholder="insira aqui a descrição">
						</div>
						<div class="mb-3">
							<label for="prioridade" class="form-label">Prioridade</label>
							<input type="text" class="form-control" id="prioridade"
								placeholder="insira aqui a prioridade">
						</div>
					</Form>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Sair</button>
					<button type="button" class="btn btn-primary" onClick="salvarTarefa()">Salvar</button>
				</div>
			</div>
		</div>
	</div>
	
	<!-- Modal Atualizar Tarefa -->
	<div class="modal fade" id="modalAtualizarTarefa" tabindex="-1" aria-labelledby="exampleModalLabel"
		aria-hidden="true">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" id="exampleModalLabel">Cadastrar Nova Tarefa</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
				</div>
				<div class="modal-body">
					<Form>

						<div class="mb-3">
							<label for="titulo" class="form-label">Título</label>
							<input type="text" class="form-control" id="titulo" placeholder="insira aqui o título">
						</div>
						<div class="mb-3">
							<label for="descricao" class="form-label">Descrição</label>
							<input type="text" class="form-control" id="descricao"
								placeholder="insira aqui a descrição">
						</div>
						<div class="mb-3">
							<label for="prioridade" class="form-label">Prioridade</label>
							<input type="text" class="form-control" id="prioridade"
								placeholder="insira aqui a prioridade">
						</div>
					</Form>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Sair</button>
					<button type="button" class="btn btn-primary" onClick="atualizarTarefa()">Salvar</button>
				</div>
			</div>
		</div>
	</div>
	<!-- Modal Buscar uma Tarefa -->
	<div class="modal fade modal-fullscreen-sm-down" id="modalBuscarTarefa" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" id="exampleModalLabel">Buscar Tarefa</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" onclick="atualizarTela()"></button>
				</div>
				<div class="modal-body">
					<Form>

						<div class="mb-3">
							<label for="titulobusca" class="form-label">Nome</label>
							<input type="text" class="form-control" id="titulobusca" placeholder="insira aqui o título">
						</div>
						<button type="button" class="btn btn-success" onClick="buscarTarefa()">Buscar</button>
					</Form>
					<table class="table" id="tabelabuscar">
						<thead>
							<tr>
								<th scope="col">Id</th>
								<th scope="col">Título</th>
								<th scope="col">Descrição</th>
								<th scope="col">Data</th>
								<th scope="col">Prioridade</th>
								<th scope="col">Deletar</th>
							</tr>
						</thead>
						<tbody>
						</tbody>
					</table>

				</div>
			</div>
		</div>
	</div>

	<!-- Option 1: Bootstrap Bundle with Popper -->
	<script src="https://code.jquery.com/jquery-3.6.0.min.js"
		integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"
		integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p"
		crossorigin="anonymous"></script>


	<!-- Campos das Funções JavaScript -->
	<script type="text/javascript">
		//Atualiza a página uma vez 0,5 pra buscar automática a lista
		setTimeout(listarTarefas, 500) //0,5 segundos
		
		function atualizarTela(){
			location.reload();
		}
		
		function atualizarTarefa() {
			
			//alert("Título: "+ titulo + "Data: "+ dataAtual);

			$.ajax({
					method: "GET",
					url: "tarefas/buscar",
					data: "id="+id,
					success: function (response) {
						
						$("#modalAtualizarTarefa#id").val(response.id);
						$("#modalAtualizarTarefa#titulo").val(response.titulo);
						$("#modalAtualizarTarefa#descricao").val(response.descricao);
						$("#modalAtualizarTarefa#data").val(response.data);
						$("#modalAtualizarTarefa#prioridade").val(response.prioridade);
						
						$("#modalAtualizarTarefa").modal-open();
						
						
						
						
					}
				}).fail(function (xhr, status, errorThrown) {
					
					alert("Erro ao Buscar Usuário por ID: " + xhr.responseText);
				});


		}
		
		
		
		function salvarTarefa() {
			var titulo = $("#titulo").val();
			var descricao = $("#descricao").val();
			var getData = new Date();
			var dia = getData.getDate();
			var mes = getData.getMonth();
			var ano = getData.getFullYear();

			var dataAtual = dia + '/' + mes + '/' + ano;
			var prioridade = $("#prioridade").val();

			//alert("Título: "+ titulo + "Data: "+ dataAtual);

			$.ajax({
				method: "POST",
				url: "tarefas/inserir",
				data: JSON.stringify(
					{
						titulo: titulo,
						descricao: descricao,
						data: dataAtual,
						prioridade: prioridade
					}
				),
				contentType: "application/json; charset-utf-8",
				success: function (response) {
					alert("Tarefa Salva Com Sucesso! " + response);
					location.reload(); //Atualiza a página
				}
			}).fail(function (xhr, status, errorThrown) {
				alert("Erro ao Salvar Tarefa: " + xhr.responseText);
			});

		}

		/*Função de Listar por Prioridade*/
		function listarTarefas() {
			$.ajax({
				method: "GET",
				url: "tarefas/page",
				contentType: "application/json; charset-utf-8",
				success: function (response) {
					console.log(response.content.length);
					$('#tabelaprincipal > tbody > tr').remove
					for (var i = 0; i < response.content.length; i++) {
						console.log(i);
						$('#tabelaprincipal > tbody').append(
							'<tr><td>' + response.content[i].id + '</td><td>' + response.content[i].titulo + '</td><td>' + response.content[i].descricao + '</td><td>' + response.content[i].data + '</td><td>' + response.content[i].prioridade + '</td><td><button type="button" class="btn btn-warning onclick="atualizarTarefa('+response.content[i].id+')"">Editar</button></td></tr>'
						);
					}
					//alert("Tarefa Salva Com Sucesso! " + response.getData);
				}
			}).fail(function (xhr, status, errorThrown) {
				alert("Erro ao Salvar Tarefa: " + xhr.responseText);
			});

		}
		
		function deletarTarefa(id) {
				console.log("id recebido ");
						
				$.ajax({
					method: "DELETE",
					url: "tarefas/delete",
					data: "id="+id,
					success: function (response) {
						$('#'+id).remove();
						alert("Tarefa excluída com sucesso! ");
						
						
						
					}
				}).fail(function (xhr, status, errorThrown) {
					
					alert("Erro ao Buscar Usuário por ID: " + xhr.responseText);
				});

			}

		function buscarTarefa() {
			var titulo = $('#titulobusca').val();
			
			if (titulo != null && titulo.trim() != '') {
				
				$.ajax({
					method: "GET",
					url: "tarefas/buscarnome",
					data: "titulo="+titulo,
					success: function (response) {
						$('#tabelabuscar > tbody > tr').remove();
						for (var i = 0; i < response.length; i++) {
							$('#tabelabuscar > tbody').append(
								'<tr id="'+response[i].id+'"><td>' + response[i].id + '</td><td>' + response[i].titulo + '</td><td>' + response[i].descricao + '</td><td>' + response[i].data + '</td><td>' + response[i].prioridade + '</td><td><button type="button" onclick="deletarTarefa('+response[i].id+')" class="btn btn-danger" >Deletar</button></td></tr>'
							);
						}
						//alert("Tarefa Salva Com Sucesso! " + response.getData);
					}
				}).fail(function (xhr, status, errorThrown) {
					alert("Erro ao Buscar Tarefa: " + xhr.responseText);
				});

			}
			
			



		}



	</script>
</body>

</html>